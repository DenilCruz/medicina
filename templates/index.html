<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Universitario</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent: #bb86fc;
            --correct: #03dac6; /* Verde/Cyan para correctas */
            --correct-bg: rgba(3, 218, 198, 0.1);
            --wrong: #cf6679;   /* Rojo para incorrectas */
            --wrong-bg: rgba(207, 102, 121, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            width: 90%;
            max-width: 600px;
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        h2 { text-align: center; color: var(--accent); }

        .progress-bar {
            height: 6px;
            background-color: #333;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .options-list {
            list-style: none;
            padding: 0;
        }

        .option-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-btn:hover:not(:disabled) {
            background-color: #383838;
            border-color: var(--accent);
        }

        .option-btn:disabled { cursor: default; }

        /* Estilos de validaci√≥n */
        .correct {
            background-color: var(--correct-bg) !important;
            border-color: var(--correct) !important;
            color: var(--correct) !important;
        }

        .wrong {
            background-color: var(--wrong-bg) !important;
            border-color: var(--wrong) !important;
            color: var(--wrong) !important;
        }

        .feedback-box {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background-color: #252525;
            border-left: 4px solid var(--accent);
            display: none; /* Oculto por defecto */
        }

        .btn-next {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: var(--accent);
            color: black;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            display: none; /* Oculto hasta responder */
        }

        .btn-next:hover { opacity: 0.9; }

        #admin-panel {
            margin-top: 30px;
            border-top: 1px solid #444;
            padding-top: 20px;
            font-size: 0.8rem;
            color: #777;
        }
        textarea { width: 100%; height: 60px; background: #222; color: #fff; border: 1px solid #444; }
    </style>
</head>
<body>

<div class="container">
    <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>

    <div id="quiz-container">
        <h2 id="question-number">Cargando...</h2>
        <p class="question-text" id="question-text"></p>
        <div class="options-list" id="options-container"></div>

        <div class="feedback-box" id="feedback">
            <strong id="feedback-title"></strong>
            <p id="feedback-text"></p>
            <small style="color: #aaa;">üìÑ Referencia: P√°gina <span id="feedback-page"></span></small>
        </div>

        <button class="btn-next" id="next-btn" onclick="nextQuestion()">Siguiente Pregunta</button>
    </div>

    <details id="admin-panel">
        <summary>Administraci√≥n (Cargar Banco de Preguntas)</summary>
        
        <div style="margin-top: 10px; padding: 10px; border: 1px dashed #666; text-align: center;">
            <p>Sube un archivo .json con preguntas masivas</p>
            <input type="file" id="file-input" accept=".json" style="color: white;">
            <button onclick="uploadFile()" style="margin-top:10px; padding:8px 15px; cursor:pointer;">Subir Archivo</button>
        </div>

        <p style="text-align: center; margin: 10px;">--- O ---</p>

        <textarea id="json-input" placeholder="O pega el JSON aqu√≠..."></textarea>
        <button onclick="uploadText()" style="width:100%; padding:5px;">Subir Texto</button>
    </details>
</div>

<script>
    let questions = [];
    let currentIdx = 0;
    let score = 0;

    async function loadQuiz() {
        try {
            const res = await fetch('/api/quiz');
            questions = await res.json();
            if(questions.length > 0) {
                currentIdx = 0;
                showQuestion();
            } else {
                document.getElementById('question-text').innerText = "No hay preguntas en la base de datos. Usa el panel de abajo para cargar un JSON.";
                document.getElementById('question-number').innerText = "Vac√≠o";
            }
        } catch (e) {
            console.error(e);
        }
    }

    function showQuestion() {
        const q = questions[currentIdx];
        document.getElementById('question-number').innerText = `Pregunta ${currentIdx + 1} / ${questions.length}`;
        document.getElementById('question-text').innerText = q.pregunta;

        // Barra de progreso
        const percent = ((currentIdx) / questions.length) * 100;
        document.getElementById('progress').style.width = percent + '%';

        // Opciones
        const container = document.getElementById('options-container');
        container.innerHTML = '';

        document.getElementById('feedback').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';

        q.opciones.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt.texto;
            btn.onclick = () => checkAnswer(opt, btn, q);
            container.appendChild(btn);
        });
    }

    function checkAnswer(selectedOpt, btnElement, questionData) {
        // Deshabilitar todos los botones
        const buttons = document.querySelectorAll('.option-btn');
        buttons.forEach(b => b.disabled = true);

        const feedbackBox = document.getElementById('feedback');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackText = document.getElementById('feedback-text');
        const feedbackPage = document.getElementById('feedback-page');

        feedbackBox.style.display = 'block';
        feedbackPage.innerText = questionData.pagina;
        feedbackText.innerText = questionData.explicacion;

        if (selectedOpt.es_correcta) {
            btnElement.classList.add('correct');
            feedbackTitle.innerText = "¬°Correcto! üéâ";
            feedbackTitle.style.color = "var(--correct)";
            score++;
        } else {
            btnElement.classList.add('wrong');
            feedbackTitle.innerText = "Incorrecto ‚ùå";
            feedbackTitle.style.color = "var(--wrong)";

            // Resaltar la correcta autom√°ticamente
            buttons.forEach((b, index) => {
                if(questionData.opciones[index].es_correcta) {
                    b.classList.add('correct');
                }
            });
        }

        document.getElementById('next-btn').style.display = 'block';

        // Si es la √∫ltima
        if (currentIdx === questions.length - 1) {
            document.getElementById('next-btn').innerText = "Finalizar";
        }
    }

    function nextQuestion() {
        if (currentIdx < questions.length - 1) {
            currentIdx++;
            showQuestion();
        } else {
            // Fin del juego
            document.getElementById('quiz-container').innerHTML = `
                <h2 style="color:var(--correct)">¬°Examen Terminado!</h2>
                <p style="text-align:center; font-size:2rem;">Tu nota: ${score} / ${questions.length}</p>
                <button class="btn-next" style="display:block" onclick="location.reload()">Intentar de nuevo</button>
            `;
            document.getElementById('progress').style.width = '100%';
        }
    }

    async function uploadJSON() {
        const jsonText = document.getElementById('json-input').value;
        try {
            const res = await fetch('/admin/importar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: jsonText
            });
            const data = await res.json();
            alert(data.message);
            location.reload();
        } catch (e) {
            alert("Error al subir JSON. Revisa el formato.");
        }
    }

    // Funci√≥n para subir texto pegado (la que ya ten√≠as, renombrada)
    async function uploadText() {
        const jsonText = document.getElementById('json-input').value;
        sendData(jsonText);
    }

    // NUEVA: Funci√≥n para leer el archivo subido
    function uploadFile() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];

        if (!file) {
            alert("Por favor selecciona un archivo JSON primero.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const jsonText = e.target.result;
            sendData(jsonText); // Enviamos el contenido le√≠do
        };
        reader.readAsText(file);
    }

    // Funci√≥n auxiliar para enviar al Backend
    async function sendData(jsonString) {
        try {
            // Validamos que sea JSON v√°lido antes de enviarlo
            JSON.parse(jsonString); 

            const res = await fetch('/admin/importar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: jsonString
            });
            const data = await res.json();
            
            if(data.status === "success"){
                alert("¬°√âxito! " + data.message);
                location.reload();
            } else {
                alert("Error del servidor: " + data.message);
            }
        } catch (e) {
            alert("El texto o archivo no tiene un formato JSON v√°lido. Revisa las comas y llaves.");
            console.error(e);
        }
    }

    // Iniciar
    loadQuiz();
</script>

</body>
</html>